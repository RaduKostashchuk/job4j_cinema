<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Бронирование мест</title>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" ></script>
<script>
    function validate() {
        let radios = [document.getElementById("radio11"), document.getElementById("radio12"), document.getElementById("radio13"),
            document.getElementById("radio21"), document.getElementById("radio22"), document.getElementById("radio23"),
            document.getElementById("radio31"),  document.getElementById("radio32"),  document.getElementById("radio33")];
        for (let i = 0; i < radios.length; i++) {
            if (radios[i] !== null && radios[i].checked === true) {
                    return radios[i].id;
            }
        }
        return "";
    }
    function goToPayment() {
        let place = validate();
        if (place !== "") {
            place = place.substring(5,7);
            window.location.assign("payment.html" + "?" + place);
        } else {
            alert("Выберите место");
        }
    }
    function getTickets() {
        return $.ajax({
            type: 'GET',
            url: 'http://localhost:8080/cinema/hall',
            dataType: 'json'
        })
    }
    function reDrawHall() {
        window.onload = getTickets().done(function (data) {
            let places = ["11", "12", "13", "21", "22", "23", "31", "32", "33"];
            let used = [];
            let usedCount = 0;
            for (let ticket of data) {
                let row = ticket.row.toString();
                let col = ticket.col.toString();
                used.push(row.concat(col));
            }
            for (let i = 0; i < places.length; i++) {
                let td = document.getElementById(places[i]);
                while (td.firstChild) {
                    td.removeChild(td.firstChild);
                }
                if (used.includes(places[i])) {
                    let span = document.createElement("span");
                    span.innerText = "Продано";
                    span.className = "badge badge-warning m-2";
                    td.appendChild(span);
                    usedCount++;
                } else {
                    let span = document.createElement("span");
                    span.innerText = "Купить";
                    span.className = "badge badge-success m-2";
                    let input = document.createElement("input");
                    input.type = "radio";
                    input.id = "radio" + places[i];
                    input.name = "place";
                    input.value = places[i];
                    td.append(span);
                    td.append(input);
                }
            }
            let payButton = document.getElementById("payButton");
            payButton.disabled = usedCount === places.length;
        })
    }
    reDrawHall();
    setInterval(reDrawHall, 30000);
</script>
</head>
<body>
<div class="container">
    <div class="row pt-3">
        <h4 id="mainHeader">
            Бронирование мест на сеанс
        </h4>
        <table class="table table-bordered">
            <thead class="thead-light">
            <tr>
                <th style="width: 120px;">Ряд / Место</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <th class="table-active">1</th>
                <td id="11">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio11" value="11">
                </td>
                <td id="12">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio12" value="12">
                </td>
                <td id="13">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio13" value="13">
                </td>
            </tr>
            <tr>
                <th class="table-active">2</th>
                <td id="21">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio21" value="21">
                </td>
                <td id="22">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio22" value="22">
                </td>
                <td id="23">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio23" value="23">
                </td>
            </tr>
            <tr>
                <th class="table-active">3</th>
                <td id="31">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio31" value="31">
                </td>
                <td id="32">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio32" value="32">
                </td>
                <td id="33">
                    <span class="badge badge-success">Купить</span>
                    <input type="radio" name="place" id="radio33" value="33">
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row float-right">
        <button type="button" class="btn btn-success" id="payButton" onclick="goToPayment()">Оплатить</button>
    </div>
</div>
</body>
</html>